<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Signal Processing - Real-Time Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Satellite Signal Processing Dashboard</h1>
            <div class="status">
                <span class="online">SYSTEM ONLINE</span> | Last Update: 
                <span id="update-time">--:--:--</span>
            </div>
        </header>

        <div class="controls">
            <button onclick="toggleAutoRefresh()">Auto Refresh: ON</button>
            <button onclick="exportData()">Export Data</button>
            <button onclick="resetMetrics()">Reset Metrics</button>
            <button onclick="refreshDashboard()">Refresh Now</button>
        </div>

        <div class="alerts" id="alerts-container">
            <h2>System Alerts</h2>
            <div class="alert-item">
                <strong class="online">OK</strong>: All systems nominal
                <div class="alert-time">Just now</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h2>Signal Metrics</h2>
                <div class="metric">
                    <span class="metric-label">SNR</span>
                    <span class="metric-value info" id="snr">8.0 dB</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="40">40%</div>
                </div>
                <div class="metric metric-spacer">
                    <span class="metric-label">Lock Status</span>
                    <span class="metric-value online" id="lock-status">LOCKED</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Signal Power</span>
                    <span class="metric-value info" id="signal-power">1.32 dBm</span>
                </div>
            </div>

            <div class="card">
                <h2>Doppler Tracking</h2>
                <div class="metric">
                    <span class="metric-label">Doppler Shift</span>
                    <span class="metric-value info" id="doppler">5.0 kHz</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="60">60%</div>
                </div>
                <div class="metric metric-spacer">
                    <span class="metric-label">Tracking Error</span>
                    <span class="metric-value online" id="tracking-error">&plusmn;0.5 Hz</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Frequency</span>
                    <span class="metric-value info" id="frequency">10.00 GHz</span>
                </div>
            </div>

            <div class="card">
                <h2>Ephemeris Data</h2>
                <div class="metric">
                    <span class="metric-label">Satellite</span>
                    <span class="metric-value info">ISS</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Azimuth</span>
                    <span class="metric-value info" id="azimuth">54.1°</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Elevation</span>
                    <span class="metric-value info" id="elevation">45.2°</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Range</span>
                    <span class="metric-value info" id="range">6750 km</span>
                </div>
            </div>

            <div class="card">
                <h2>Filter Status</h2>
                <div class="metric">
                    <span class="metric-label">FIR Taps</span>
                    <span class="metric-value info">64</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Cutoff Freq</span>
                    <span class="metric-value info">100 kHz</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Latency</span>
                    <span class="metric-value online">&lt; 1 ms</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="100">100%</div>
                </div>
            </div>

            <div class="card">
                <h2>Demodulation</h2>
                <div class="metric">
                    <span class="metric-label">Modulation</span>
                    <span class="metric-value info">QPSK</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Symbols/sec</span>
                    <span class="metric-value info">1 kHz</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Bits Recovered</span>
                    <span class="metric-value online" id="bits-recovered">1000</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="95">95%</div>
                </div>
            </div>

            <div class="card">
                <h2>System Status</h2>
                <div class="metric">
                    <span class="metric-label">Receiver</span>
                    <span class="metric-value online">ACTIVE</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value info" id="memory">45%</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="45">45%</div>
                </div>
                <div class="metric metric-spacer">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value info" id="cpu">32%</span>
                </div>
                <div class="gauge">
                    <div class="gauge-fill" data-width="32">32%</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2>Signal Power Over Time</h2>
            <canvas id="power-chart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Doppler Shift Tracking</h2>
            <canvas id="doppler-chart"></canvas>
        </div>

        <div class="chart-container">
            <h2>SNR Evolution</h2>
            <canvas id="snr-chart"></canvas>
        </div>

        <div class="chart-container">
            <h2>Performance Benchmarks</h2>
            <div id="benchmarks-container"></div>
        </div>

        <div class="footer">
            <p>Real-Time Satellite Signal Processing Dashboard</p>
            <p>Frequency: 10 GHz | Sample Rate: 1 Msps | Ground Station: Boulder, CO (40N, 105W)</p>
            <p>For full documentation, see: SATELLITE_SIGNAL_PROCESSING_GUIDE.txt</p>
        </div>
    </div>

    <script>
        let autoRefreshEnabled = true;
        let benchmarkData = null;
        let powerChart, dopplerChart, snrChart;
        let timeSeriesData = {
            labels: [],
            power: [],
            doppler: [],
            snr: []
        };

        function initializeGaugeFills() {
            document.querySelectorAll('.gauge-fill[data-width]').forEach(fill => {
                const width = fill.getAttribute('data-width');
                fill.style.width = width + '%';
            });
        }

        function getHealthStatus(timeMs) {
            if (timeMs < 1.0) return { status: 'excellent', color: '#00ff88', label: '✓ Excellent' };
            if (timeMs < 5.0) return { status: 'good', color: '#00ff00', label: '✓ Good' };
            if (timeMs < 10.0) return { status: 'acceptable', color: '#ffff00', label: '! Acceptable' };
            return { status: 'poor', color: '#ff4444', label: '✗ Needs Optimization' };
        }

        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 10
                },
                plugins: {
                    legend: {
                        labels: { 
                            color: '#ffffff', 
                            font: { size: 13, weight: 'bold' },
                            padding: 15,
                            usePointStyle: true,
                            boxWidth: 12
                        }
                    },
                    title: {
                        display: true,
                        color: '#ffffff',
                        font: { size: 15, weight: 'bold' },
                        padding: 15
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (seconds)',
                            color: '#00ffff',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: { 
                            color: '#00ff88', 
                            font: { size: 11, weight: 'bold' },
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: { color: 'rgba(0, 255, 136, 0.5)', lineWidth: 1.5 }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Value',
                            color: '#00ffff',
                            font: { size: 12, weight: 'bold' }
                        },
                        ticks: { 
                            color: '#00ff88', 
                            font: { size: 11, weight: 'bold' },
                            callback: function(value) {
                                return value.toFixed(2);
                            }
                        },
                        grid: { color: 'rgba(0, 255, 136, 0.5)', lineWidth: 1.5 }
                    }
                }
            };

            // Signal Power Chart
            const powerCtx = document.getElementById('power-chart').getContext('2d');
            powerChart = new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: [{
                        label: 'Signal Power (dBm)',
                        data: timeSeriesData.power,
                        borderColor: '#00ff88',
                        borderWidth: 3,
                        backgroundColor: 'rgba(0, 255, 136, 0.15)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBorderWidth: 2,
                        pointBorderColor: '#ffffff',
                        pointBackgroundColor: '#00ffff'
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: { ...chartOptions.plugins.title, text: '📊 Signal Power Over Time' }
                    },
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, title: { ...chartOptions.scales.y.title, text: 'Power (dBm)' } }
                    }
                }
            });

            // Doppler Shift Chart
            const dopplerCtx = document.getElementById('doppler-chart').getContext('2d');
            dopplerChart = new Chart(dopplerCtx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: [{
                        label: 'Doppler Shift (kHz)',
                        data: timeSeriesData.doppler,
                        borderColor: '#00ffff',
                        borderWidth: 3,
                        backgroundColor: 'rgba(0, 255, 255, 0.15)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBorderWidth: 2,
                        pointBorderColor: '#ffffff',
                        pointBackgroundColor: '#00ff88'
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: { ...chartOptions.plugins.title, text: '🛰️ Doppler Shift Tracking' }
                    },
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, title: { ...chartOptions.scales.y.title, text: 'Shift (kHz)' } }
                    }
                }
            });

            // SNR Evolution Chart
            const snrCtx = document.getElementById('snr-chart').getContext('2d');
            snrChart = new Chart(snrCtx, {
                type: 'line',
                data: {
                    labels: timeSeriesData.labels,
                    datasets: [{
                        label: 'SNR (dB)',
                        data: timeSeriesData.snr,
                        borderColor: '#ffff00',
                        borderWidth: 3,
                        backgroundColor: 'rgba(255, 255, 0, 0.15)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointBorderWidth: 2,
                        pointBorderColor: '#ffffff',
                        pointBackgroundColor: '#ff00ff'
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        title: { ...chartOptions.plugins.title, text: '📈 SNR Evolution' }
                    },
                    scales: {
                        ...chartOptions.scales,
                        y: { ...chartOptions.scales.y, title: { ...chartOptions.scales.y.title, text: 'SNR (dB)' } }
                    }
                }
            });
        }

        function generateTimeSeriesData() {
            timeSeriesData.labels = [];
            timeSeriesData.power = [];
            timeSeriesData.doppler = [];
            timeSeriesData.snr = [];

            for (let i = 0; i < 30; i++) {
                const time = new Date(Date.now() - (30 - i) * 2000);
                timeSeriesData.labels.push(time.toLocaleTimeString());
                
                // Generate realistic variations with trends
                const trendFactor = i / 30;
                const powerNoise = (Math.random() - 0.5) * 0.5;
                const dopplerNoise = (Math.random() - 0.5) * 1.5;
                const snrNoise = (Math.random() - 0.5) * 2;
                
                timeSeriesData.power.push(1.2 + trendFactor * 0.3 + powerNoise);
                timeSeriesData.doppler.push(4.8 + Math.sin(trendFactor * Math.PI) * 2 + dopplerNoise);
                timeSeriesData.snr.push(8.0 + trendFactor * 1.5 + snrNoise);
            }
        }

        async function loadBenchmarks() {
            try {
                const response = await fetch('./benchmark_results.json');
                if (response.ok) {
                    benchmarkData = await response.json();
                    console.log(' Benchmarks loaded successfully:', benchmarkData);
                    displayBenchmarks();
                } else {
                    console.log('❌ benchmark_results.json not found (HTTP ' + response.status + ')');
                    displayBenchmarkPlaceholder('File not found - Run benchmark_suite.exe first');
                }
            } catch (error) {
                console.log('❌ Benchmarks loading error:', error.message);
                console.log('Current location:', window.location.href);
                console.log('Attempting alternate path...');
                
                // Try with absolute path as fallback
                try {
                    const fallbackResponse = await fetch('/benchmark_results.json');
                    if (fallbackResponse.ok) {
                        benchmarkData = await fallbackResponse.json();
                        console.log(' Benchmarks loaded from fallback path');
                        displayBenchmarks();
                        return;
                    }
                } catch (fallbackError) {
                    // Fallback also failed
                }
                
                displayBenchmarkPlaceholder('Benchmarks not available - Ensure HTTP server is running');
            }
        }

        function displayBenchmarkPlaceholder(message) {
            const container = document.getElementById('benchmarks-container');
            container.innerHTML = `<div style="padding: 20px; background: rgba(100, 50, 50, 0.5); border: 2px dashed #ff6666; border-radius: 8px; color: #ffaaaa; text-align: center;">
                <p style="font-size: 1.1em; margin: 10px 0;"><strong>⚠️ ${message}</strong></p>
                <p style="font-size: 0.9em; color: #ff9999;">To generate benchmark data:</p>
                <p style="font-size: 0.9em; color: #ffcccc; font-family: monospace;">./build/Release/benchmark_suite.exe</p>
            </div>`;
        }

        function displayBenchmarks() {
            if (!benchmarkData || !benchmarkData.benchmarks) {
                displayBenchmarkPlaceholder('Invalid benchmark data');
                return;
            }

            const container = document.getElementById('benchmarks-container');
            container.innerHTML = '';

            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; color: #ffffff; background: rgba(0, 20, 40, 0.8);';
            
            // Header
            const header = table.createTHead();
            const headerRow = header.insertRow();
            const headers = ['Benchmark', 'Min (ms)', 'Mean (ms)', 'Max (ms)', 'StdDev', 'Health'];
            
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                th.style.cssText = 'padding: 12px; text-align: left; border-bottom: 3px solid #00ff88; color: #ffffff; font-weight: bold; font-size: 0.95em; background: rgba(0, 50, 80, 0.8);';
                headerRow.appendChild(th);
            });

            // Data rows
            const tbody = table.createTBody();
            benchmarkData.benchmarks.forEach((bench, idx) => {
                const row = tbody.insertRow();
                const health = getHealthStatus(bench.mean_ms);
                const bgColor = idx % 2 === 0 ? 'rgba(0, 30, 50, 0.4)' : 'rgba(0, 40, 60, 0.3)';
                row.style.backgroundColor = bgColor;
                
                const cells = [
                    bench.name,
                    bench.min_ms.toFixed(6),
                    bench.mean_ms.toFixed(6),
                    bench.max_ms.toFixed(6),
                    bench.stddev_ms.toFixed(6),
                    health.label
                ];

                cells.forEach((cellData, cellIdx) => {
                    const cell = row.insertCell();
                    cell.textContent = cellData;
                    cell.style.cssText = `padding: 10px; border-bottom: 1px solid rgba(0,255,136,0.2); color: #ffffff; font-weight: 500;`;
                    
                    if (cellIdx === 5) {
                        cell.style.color = health.color;
                        cell.style.fontWeight = 'bold';
                        cell.style.fontSize = '1.05em';
                    }
                });
            });

            container.appendChild(table);

            // Add summary
            const summary = document.createElement('div');
            summary.style.cssText = 'margin-top: 20px; padding: 20px; background: rgba(0, 50, 50, 0.7); border-radius: 8px; border: 2px solid #00ff88;';
            
            const avgMean = benchmarkData.benchmarks.reduce((sum, b) => sum + b.mean_ms, 0) / benchmarkData.benchmarks.length;
            const maxTime = Math.max(...benchmarkData.benchmarks.map(b => b.max_ms));
            const health = getHealthStatus(avgMean);
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                    <div>
                        <div style="color: #ffffff; font-size: 0.95em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Average Time</div>
                        <div style="font-size: 1.5em; color: #00ff88; font-weight: bold; margin-top: 5px;">${avgMean.toFixed(4)} ms</div>
                    </div>
                    <div>
                        <div style="color: #ffffff; font-size: 0.95em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Max Time</div>
                        <div style="font-size: 1.5em; color: #ff8888; font-weight: bold; margin-top: 5px;">${maxTime.toFixed(4)} ms</div>
                    </div>
                    <div>
                        <div style="color: #ffffff; font-size: 0.95em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">System Health</div>
                        <div style="font-size: 1.5em; color: ${health.color}; font-weight: bold; margin-top: 5px;">${health.label}</div>
                    </div>
                    <div>
                        <div style="color: #ffffff; font-size: 0.95em; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">Last Updated</div>
                        <div style="font-size: 1.5em; color: #00ffff; font-weight: bold; margin-top: 5px;">${benchmarkData.timestamp}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(summary);
        }

        function updateDashboard() {
            const time = new Date();
            document.getElementById('update-time').textContent = time.toLocaleTimeString();
            
            const randomVariation = () => (Math.random() - 0.5) * 2;
            
            // Update metric cards
            const snrValue = 8.0 + randomVariation();
            const dopplerValue = 5.0 + randomVariation();
            const powerValue = 1.32 + randomVariation() * 0.1;
            
            document.getElementById('snr').textContent = snrValue.toFixed(2) + ' dB';
            document.getElementById('doppler').textContent = dopplerValue.toFixed(1) + ' kHz';
            document.getElementById('signal-power').textContent = powerValue.toFixed(2) + ' dBm';
            document.getElementById('memory').textContent = Math.floor(40 + randomVariation() * 10) + '%';
            document.getElementById('cpu').textContent = Math.floor(30 + randomVariation() * 10) + '%';
            
            // Update chart data with rolling window
            timeSeriesData.labels.push(time.toLocaleTimeString());
            timeSeriesData.power.push(powerValue);
            timeSeriesData.doppler.push(dopplerValue);
            timeSeriesData.snr.push(snrValue);
            
            // Keep only last 30 data points
            if (timeSeriesData.labels.length > 30) {
                timeSeriesData.labels.shift();
                timeSeriesData.power.shift();
                timeSeriesData.doppler.shift();
                timeSeriesData.snr.shift();
            }
            
            // Update charts
            if (powerChart) {
                powerChart.data.labels = timeSeriesData.labels;
                powerChart.data.datasets[0].data = timeSeriesData.power;
                powerChart.update('none');
            }
            if (dopplerChart) {
                dopplerChart.data.labels = timeSeriesData.labels;
                dopplerChart.data.datasets[0].data = timeSeriesData.doppler;
                dopplerChart.update('none');
            }
            if (snrChart) {
                snrChart.data.labels = timeSeriesData.labels;
                snrChart.data.datasets[0].data = timeSeriesData.snr;
                snrChart.update('none');
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            event.target.textContent = 'Auto Refresh: ' + (autoRefreshEnabled ? 'ON' : 'OFF');
        }

        function exportData() {
            alert('Export functionality would save current metrics to JSON/CSV');
        }

        function resetMetrics() {
            alert('Metrics have been reset');
        }

        function refreshDashboard() {
            updateDashboard();
            loadBenchmarks();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wrap canvas elements for proper sizing
            document.querySelectorAll('canvas').forEach(canvas => {
                if (canvas.id === 'power-chart' || canvas.id === 'doppler-chart' || canvas.id === 'snr-chart') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'chart-wrapper';
                    canvas.parentNode.insertBefore(wrapper, canvas);
                    wrapper.appendChild(canvas);
                }
            });
            
            initializeGaugeFills();
            generateTimeSeriesData();
            initializeCharts();
            loadBenchmarks();
            updateDashboard();
            
            // Show helpful message if running from file://
            if (window.location.protocol === 'file:') {
                console.error(' IMPORTANT: Dashboard opened via file:// - JSON loading WILL FAIL!');
                console.error(' Due to browser security, you MUST serve via HTTP server');
                console.error(' SOLUTION: Use launcher script:');
                console.error('   PowerShell: .\\run_dashboard.ps1');
                console.error('   Batch: run_dashboard.bat');
                console.error('');
                console.error('   OR manually:');
                console.error('   python -m http.server 8000');
                console.error('   Then visit: http://localhost:8000/examples_web_dashboard.html');
                
                // Show alert too
                alert(' Dashboard requires HTTP server!\n\nRun: .\\run_dashboard.ps1\n\nOr: python -m http.server 8000');
            } else {
                console.log(' Dashboard running on HTTP - JSON loading should work');
            }
        });

        // Auto-update every 2 seconds
        setInterval(() => {
            if (autoRefreshEnabled) {
                updateDashboard();
                loadBenchmarks();
            }
        }, 2000);
    </script>
</body>
</html>